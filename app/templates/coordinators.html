{% extends "base.html" %}
{% block title %}Coordinators ‚Äî AI Nexus{% endblock %}

{% block content %}
  <!-- Top bar -->
  <div class="page-bar">
    <div class="page-title">Manage Coordinators</div>
    <button type="button" class="btn btn-secondary js-open-modal" data-modal="#coordinatorModal">
      Assign Coordinator
    </button>
  </div>

  <!-- Stats -->
  <div class="small-stats-container">
    <div class="small-stat-card">
      <h3>Student Coordinators</h3>
      <div class="value">{{ student_count or 0 }}</div>
      <div class="icon">üéì</div>
    </div>
    <div class="small-stat-card">
      <h3>College-side Roles</h3>
      <div class="value">{{ faculty_count or 0 }}</div>
      <div class="icon">üë•</div>
    </div>
  </div>

  <!-- Toolbar: Search + (Filter by Club) + Sort -->
  <div class="clubs-toolbar" style="margin-top:16px;">
    <form class="search-bar" method="get" action="{{ url_for('coordinators') }}">
      <span class="search-icon">üîç</span>
      <input id="coordinatorSearch" name="q" value="{{ q or '' }}" type="text" placeholder="Search Coordinator" aria-label="Search Coordinator" />
      <div id="coordinatorChoices" hidden></div>
    </form>

    <div class="clubs-toolbar-right">
      <!-- Filter by Club (uses club-id) -->
      <label class="filter-select-wrap" aria-label="Filter by club">
        <select class="filter-select" id="coordClubFilter" name="club_id" data-filter-key="club-id">
          <option value="all" {{ 'selected' if (club_id or 'all') == 'all' }}>All clubs</option>
          {% if clubs %}
            {% for cl in clubs %}
              <option value="{{ cl.club_id }}" {{ 'selected' if (club_id or '') == cl.club_id|string }}>
                {{ cl.club_name }}
              </option>
            {% endfor %}
          {% endif %}
        </select>
      </label>

      <!-- Sort by -->
      <label class="filter-select-wrap" aria-label="Sort by">
        <select class="filter-select" id="coordSortBy" name="sort">
          <option value="none"   {{ 'selected' if (sort or 'none') == 'none' }}>Sort by</option>
          <option value="name"   {{ 'selected' if (sort or '') == 'name' }}>Coordinator Name</option>
          <option value="club"   {{ 'selected' if (sort or '') == 'club' }}>Club</option>
          <option value="newest" {{ 'selected' if (sort or '') == 'newest' }}>Newest</option>
          <option value="oldest" {{ 'selected' if (sort or '') == 'oldest' }}>Oldest</option>
        </select>
      </label>
    </div>
  </div>

  <!-- Featured Card (filled by JS) -->
  <div class="featured-chapter-card" id="featuredCoordinatorCard" hidden>
    <button class="card-close-btn" id="fcoCloseBtn" title="Close">√ó</button>
    <div class="featured-chapter-image">
      <img id="fcoImageUrl" alt="" />
    </div>

    <div class="featured-chapter-content">
      <h3 class="featured-chapter-title" id="fcoName"></h3>
      <p class="featured-chapter-description" id="fcoDescription"></p>

      <div class="featured-chapter-stats">
        <div class="featured-chapter-stat">
          <span class="icon">üè´</span>
          <span id="fcoClub">‚Äî</span>
        </div>
        <div class="featured-chapter-stat">
          <span class="icon">üè¢</span>
          <span id="fcoDepartment">‚Äî</span>
        </div>
        <div class="featured-chapter-stat">
          <span class="icon">üìß</span>
          <span id="fcoEmail">‚Äî</span>
        </div>
        <div class="featured-chapter-stat">
          <span class="icon">üì±</span>
          <span id="fcoPhone">‚Äî</span>
        </div>
      </div>

      <div class="featured-chapter-actions">
        <a href="#" class="action-btn" id="fcoEditBtn">Edit</a>
        <a href="#" class="delete-btn" id="fcoDeleteBtn">Delete</a>
      </div>
    </div>
  </div>
  <!-- Featured Card end -->

  <!-- Table -->
  <div class="table-container">
    <div class="table-header">Active Coordinators</div>
    <table class="table" data-table="coordinators">
      <thead>
        <tr>
          <th scope="col">Coordinators</th>
          <th scope="col">Clubs</th>
          <th scope="col">Department</th>
          <th scope="col">Mail Id</th>
          <th scope="col">Mobile Number</th>
          <th scope="col">Action</th>
        </tr>
      </thead>
      <tbody>
        {% if coordinators and coordinators|length %}
          {% for c in coordinators %}
            {# created fallback: zero-padded id if created_time not present #}
            <tr
                    data-id="{{ c.id }}"                          {# <-- add this #}
              data-name="{{ c.name }}"
              data-club="{{ c.club }}"
              data-club-id="{{ c.club_id }}"
              data-created="{{ (c.created_time.isoformat() if c.created_time else '%010d'|format(c.id)) }}"
            >
              <!-- Coordinator name -->
              <td data-col="name">{{ c.name|capitalize }}</td>

              <!-- Club -->
              <td data-col="club">{{ c.club }}</td>

              <!-- Department -->
              <td>{{ c.college_or_dept }}</td>

              <!-- Email -->
              <td><a href="mailto:{{ c.email }}">{{ c.email }}</a></td>

              <!-- Phone -->
              <td>{{ c.phone }}</td>

              <!-- Action -->
              <td>
                <a
                  href="#coordinatorEditModal"
                  class="action-btn js-open-modal js-edit-coordinator"
                  data-modal="#coordinatorEditModal"
                  data-id="{{ c.id }}"
                  data-name="{{ c.name }}"
                  data-club-id="{{ c.club_id }}"
                  data-college-id="{{ c.college_id or '' }}"
                  data-faculty-dept="{{ c.faculty_dept or '' }}"
                  data-role-type="{{ c.type if c.type != '‚Äî' else '' }}"
                  data-email="{{ c.email or '' }}"
                  data-phone="{{ c.phone or '' }}"
                  data-description="{{ c.description or '' }}"
                  data-status="{{ (c.status or 'active')|lower }}"
                  data-image-url="{{ url_for('static', filename=c.image_path) if c.image_path else '' }}"
                  data-image-name="{{ c.image_path.split('/')[-1] if c.image_path else '' }}"
                >Edit</a>
                <a href="#" class="delete-btn js-delete-coordinator" data-id="{{ c.id }}" data-name="{{ c.name }}">Delete</a>
              </td>
            </tr>
          {% endfor %}
        {% else %}
          <tr>
            <td colspan="6" style="text-align:center; padding:16px; color:#666;">
              No active coordinators found. Use <em>Assign Coordinator</em> to add one.
            </td>
          </tr>
        {% endif %}
      </tbody>
    </table>
              <nav id="coordinatorsPagination" class="pagination" aria-label="Coordinators pagination"></nav>

  </div>

  {% include "components/coordinator_modal.html" %}
  {% include "components/coordinator_edit_modal.html" %}

{# Hidden delete forms (template-route fallback) #}
<form id="deleteClubForm" method="POST" action="{{ url_for('delete_club_form') }}" style="display:none;">
  <input type="hidden" name="club_id" id="deleteClubId">
</form>
<form id="deleteEventForm" method="POST" action="{{ url_for('delete_event_form') }}" style="display:none;">
  <input type="hidden" name="event_id" id="deleteEventId">
</form>
<form id="deleteCollegeForm" method="POST" action="{{ url_for('delete_college_form') }}" style="display:none;">
  <input type="hidden" name="college_id" id="deleteCollegeId">
</form>
<form id="deleteCoordinatorForm" method="POST" action="{{ url_for('delete_coordinator_form') }}" style="display:none;">
  <input type="hidden" name="coordinator_id" id="deleteCoordinatorId">
</form>
<form id="deleteAnnouncementForm" method="POST" action="{{ url_for('delete_announcement_form') }}" style="display:none;">
  <input type="hidden" name="announcement_id" id="deleteAnnouncementId">
</form>

{# Delete confirmation modal (Flipkart style) #}
<div id="deleteConfirmModal" class="delete-modal-overlay" hidden>
  <div class="delete-modal">
    <div class="delete-modal-header">
      <h3>Delete Coordinator</h3>
      <button type="button" class="delete-close" id="closeDeleteModal">√ó</button>
    </div>
    <div class="delete-modal-body">
      <p>Are you sure you want to delete this coordinator?</p>
    </div>
    <div class="delete-modal-footer">
      <button id="confirmDeleteBtn" class="btn btn-danger">DELETE</button>
      <button id="cancelDeleteBtn" class="btn btn-secondary">CANCEL</button>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
  <script src="{{ url_for('static', filename='scripts.js') }}"></script>
{% endblock %}
