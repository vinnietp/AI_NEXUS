  {% extends "base.html" %}
{% block title %}Members — AI Nexus{% endblock %}

{% block content %}
  <!-- Top bar -->
  <div class="page-bar">
    <div class="page-title">Manage Members</div>
    <button type="button" class="btn btn-secondary js-open-modal" data-modal="#memberModal">
      Add Member
    </button>
  </div>

  <!-- Stats -->
  <div class="small-stats-container">
    <div class="small-stat-card">
      <h3>Total Members</h3>
      <div class="value">{{ total_members or 0 }}</div>
      <div class="icon">🎓</div>
    </div>
    <div class="small-stat-card">
      <h3>Active Members</h3>
      <div class="value">{{ active_members or 0 }}</div>
      <div class="icon">🎓</div>
    </div>
    <div class="small-stat-card">
      <h3>Inactive Members</h3>
      <div class="value">{{ inactive_members or 0 }}</div>
      <div class="icon">🎓</div>
    </div>
  </div>

  <!-- Toolbar: Search + (Filter by Club) + (Filter by Status) + Sort -->
  <!-- Toolbar: search (left) + RHS filters (right) -->
<div class="clubs-toolbar" style="margin-top:16px;">
  <!-- Search -->
  <form class="search-bar" method="get" action="{{ url_for('members') }}">
    <span class="search-icon">🔍</span>
    <input
      type="text"
      id="memberSearch"
      name="q"
      value="{{ q or '' }}"
      placeholder="Search Members"
    />
    <div id="memberChoices" hidden></div>
  </form>

  <!-- Right side filters -->
  <div class="clubs-toolbar-right">
    <label class="filter-select-wrap" aria-label="Filter by status">
      <select class="filter-select" id="memberStatusFilter" name="status">
        <option value="all" {{ 'selected' if (status or 'all') == 'all' }}>All statuses</option>
        <option value="active" {{ 'selected' if (status or '') == 'active' }}>Active</option>
        <option value="inactive" {{ 'selected' if (status or '') == 'inactive' }}>Inactive</option>
      </select>
    </label>

    <label class="filter-select-wrap" aria-label="Sort by">
      <select class="filter-select" id="memberSortBy" name="sort">
        <option value="none"   {{ 'selected' if (sort or 'none') == 'none' }}>Sort by</option>
        <option value="name"   {{ 'selected' if (sort or '') == 'name' }}>Member Name</option>
        <option value="club"   {{ 'selected' if (sort or '') == 'club' }}>Club</option>
        <option value="college" {{ 'selected' if (sort or '') == 'college' }}>College Name</option>
        <option value="email"  {{ 'selected' if (sort or '') == 'email' }}>Email</option>
        <option value="newest" {{ 'selected' if (sort or '') == 'newest' }}>Newest</option>
        <option value="oldest" {{ 'selected' if (sort or '') == 'oldest' }}>Oldest</option>
      </select>
    </label>
  </div>
</div>

  <!-- Featured Card (filled by JS) -->
  <div class="featured-chapter-card" id="featuredMemberCard" hidden>
    <button class="card-close-btn" id="fmCloseBtn" title="Close">×</button>
    <div class="featured-chapter-image">
      <img id="fmImageUrl" alt="" />
    </div>

    <div class="featured-chapter-content">
      <h3 class="featured-chapter-title" id="fmName"></h3>
      <p class="featured-chapter-description" id="fmDescription"></p>

      <div class="featured-chapter-stats">
        <div class="featured-chapter-stat">
          <span class="icon">🏫</span>
          <span id="fmClub">—</span>
        </div>
        <div class="featured-chapter-stat">
          <span class="icon">🏢</span>
          <span id="fmCollege">—</span>
        </div>
        <div class="featured-chapter-stat">
          <span class="icon">📧</span>
          <span id="fmEmail">—</span>
        </div>
        <div class="featured-chapter-stat">
          <span class="icon">📱</span>
          <span id="fmPhone">—</span>
        </div>
      </div>

      <div class="featured-chapter-actions">
        <a href="#" class="action-btn" id="fmEditBtn">Edit</a>
        <a href="#" class="delete-btn" id="fmDeleteBtn">Delete</a>
      </div>
    </div>
  </div>
  <!-- Featured Card end -->

  <!-- Table -->
  <div class="table-container">
    <div class="table-header">All Members</div>
    <table class="table" data-table="members">
      <thead>
        <tr>
          <th scope="col">Members</th>
          <th scope="col">Clubs</th>
          <th scope="col">College Name</th>
<!--          <th scope="col">Mail Id</th>-->
          <th scope="col">Date Joined</th>
          <th scope="col">Status</th>
          <th scope="col">Action</th>
        </tr>
      </thead>
      <tbody>
        {% if members and members|length %}
          {% for m in members %}
            {# created fallback: zero-padded id if created_time not present #}
            <tr
              data-name="{{ m.name }}"
              data-club="{{ m.club }}"
              data-club-ids="{{ m.club_ids|join(',') }}"
              data-college="{{ m.college }}"
              data-status="{{ (m.status or 'active')|lower }}"
              data-created="{{ (m.created_time.isoformat() if m.created_time else '%010d'|format(m.id)) }}"
              data-description="{{ m.description or '' }}"
              data-email="{{ m.email or '' }}"
              data-phone="{{ m.phone or '' }}"
              data-image-url="{{ url_for('static', filename=m.image_path) if m.image_path else '' }}"
              data-image-name="{{ m.image_path.split('/')[-1] if m.image_path else '' }}"
            >
              <!-- Member name -->
              <td data-col="name">{{ m.name|capitalize }}</td>

              <!-- Club -->
              <td data-col="club">
                {% if m.club %}
                  {% for club in m.club.split(', ') %}
                    <span class="status status-club">{{ club }}</span><br>
                  {% endfor %}
                {% else %}
                  <span class="status status-club">—</span>
                {% endif %}
              </td>

              <!-- College Name -->
              <td>{{ m.college }}</td>

              <!-- Email -->
<!--              <td><a href="mailto:{{ m.email }}">{{ m.email or '—' }}</a></td>-->

              <!-- Date Joined -->
              <td>{{ m.created_time.strftime('%Y-%m-%d') if m.created_time else '—' }}</td>

              <!-- Status -->
              <td data-col="status">
                {% if (m.status or 'active')|lower == 'active' %}
                  <span class="status status-active">Active</span>
                {% else %}
                  <span class="status status-inactive">Inactive</span>
                {% endif %}
              </td>

              <!-- Action -->
              <td>
                <a
                  href="#memberEditModal"
                  class="action-btn js-open-modal js-edit-member"
                  data-modal="#memberEditModal"
                  data-id="{{ m.id }}"
                  data-name="{{ m.name }}"
                  data-club-ids="{{ m.club_ids|join(',') }}"
                  data-college-id="{{ m.college_id or '' }}"
                  data-faculty-dept="{{ m.faculty_dept or '' }}"
                  data-role-type="{{ m.type if m.type != '—' else '' }}"
                  data-email="{{ m.email or '' }}"
                  data-phone="{{ m.phone or '' }}"
                  data-description="{{ m.description or '' }}"
                  data-status="{{ (m.status or 'active')|lower }}"
                  data-image-url="{{ url_for('static', filename=m.image_path) if m.image_path else '' }}"
                  data-image-name="{{ m.image_path.split('/')[-1] if m.image_path else '' }}"
                >Edit</a>
                <a href="#" class="delete-btn js-delete-member" data-id="{{ m.id }}" data-name="{{ m.name }}">Delete</a>
              </td>
            </tr>
          {% endfor %}
        {% else %}
          <tr>
            <td colspan="7" style="text-align:center; padding:16px; color:#666;">
              No members found. Use <em>Add Member</em> to add one.
            </td>
          </tr>
        {% endif %}
      </tbody>
    </table>
  </div>
        <nav id="membersPagination" class="pagination" aria-label="Members pagination"></nav>

  {% include "components/member_modal.html" %}
  {% include "components/member_edit_modal.html" %}

{# Hidden delete forms (template-route fallback) #}
<form id="deleteMemberForm" method="POST" action="{{ url_for('delete_member_form') }}" style="display:none;">
  <input type="hidden" name="member_id" id="deleteMemberId">
</form>

{# Delete confirmation modal (Flipkart style) #}
<div id="deleteConfirmModal" class="delete-modal-overlay" hidden>
  <div class="delete-modal">
    <div class="delete-modal-header">
      <h3>Delete Member</h3>
      <button type="button" class="delete-close" id="closeDeleteModal">×</button>
    </div>
    <div class="delete-modal-body">
      <p>Are you sure you want to delete this member?</p>
    </div>
    <div class="delete-modal-footer">
      <button id="confirmDeleteBtn" class="btn btn-danger">DELETE</button>
      <button id="cancelDeleteBtn" class="btn btn-secondary">CANCEL</button>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
  <script src="{{ url_for('static', filename='scripts.js') }}"></script>
{% endblock %}
