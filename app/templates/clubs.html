{% extends "base.html" %}

{% block title %}clubs{% endblock %}

{% block content %}
<section class="page-section">
  <!-- Page bar / CTA row -->
  <div class="page-bar">
    <h1 class="page-title">Manage clubs</h1>

    <button type="button"
      class="btn btn-secondary js-open-modal"
      data-modal="#clubModal">
      Create New club
    </button>
  </div>

  <!-- Toolbar: search (left) + RHS filters (right) -->
  <div class="clubs-toolbar">
    <!-- Search -->
    <form class="search-bar" method="get" action="{{ url_for('clubs') }}">
      <span class="search-icon">üîç</span>
      <input type="text" name="q" value="{{ q or '' }}" placeholder="Search Clubs" />
      <select id="clubChoices" size="6" hidden></select>
    </form>

    <!-- Right side filters -->
    <div class="clubs-toolbar-right">
      <label class="filter-select-wrap" aria-label="Filter by status">
        <select class="filter-select" id="statusFilter" name="status">
          <option value="all">All status</option>
          <option value="active">Active</option>
          <option value="inactive">Inactive</option>
        </select>
      </label>

      <label class="filter-select-wrap" aria-label="Sort by">
        <select class="filter-select" id="sortBy" name="sort">
          <option value="none">Sort by</option>
          <option value="name">Club Name</option>
          <option value="coordinator">Coordinator Name</option>
          <option value="newest">Newest</option>
          <option value="oldest">Oldest</option>
        </select>
      </label>
    </div>
  </div>

  <!-- Featured Card (filled by JS) -->
  <div class="featured-chapter-card" id="featuredCard" hidden>
    <div class="featured-chapter-image">
      <img id="fcImage" alt="" />
    </div>

    <div class="featured-chapter-content">
      <h3 class="featured-chapter-title" id="fcTitle"></h3>
      <p class="featured-chapter-description" id="fcDesc"></p>

      <div class="featured-chapter-stats">
        <div class="featured-chapter-stat">
          <span class="icon">üë•</span>
          <span id="fcMembers">0</span> Members
        </div>
        <div class="featured-chapter-stat">
          <span class="icon">üéì</span>
          <span id="fcCoordinator">‚Äî</span>
        </div>
      </div>

      <div class="featured-chapter-actions">
        <a href="#" class="action-btn" id="fcEditBtn">Edit</a>
        <a href="#" class="delete-btn" id="fcDeleteBtn">Delete</a>
      </div>
    </div>
  </div>
  <!-- Featured Card end -->

  <!-- All clubs Table -->
  <div class="table-container">
    <div class="table-header">All clubs</div>
    <table class="table" data-table="clubs">
      <thead>
        <tr>
          <th>club</th>
          <th>Coordinator</th>
          <th>Members</th>
          <th>Colleges</th>
          <th>Status</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
      {% if clubs and clubs|length > 0 %}
        {% for ch in clubs %}
          {% set status_txt = (ch.status or 'active')|lower %}
          <tr
            data-id="{{ ch.club_id }}"
            data-name="{{ ch.club_name }}"
            data-coordinator="{{ ch.coordinator or '' }}"
            data-status="{{ status_txt }}"
            data-members="{{ ch.members or 0 }}"
            data-created="{{ ch.created_time.isoformat() if ch.created_time }}"
          >
            <!-- Club Name -->
            <td data-col="name">{{ ch.club_name }}</td>

            <!-- Coordinator -->
            <td data-col="coordinator">{{ ch.coordinator or "‚Äî" }}</td>

            <!-- Members (placeholder until implemented) -->
            <td>0</td>

            <!-- Colleges (placeholder until implemented) -->
            <td>‚Äî</td>

            <!-- Status -->
            <td data-col="status">
              <span class="status {{ 'status-active' if status_txt == 'active' else 'status-inactive' }}">
                {{ status_txt|capitalize }}
              </span>
            </td>

            <!-- Actions -->
            <td>
              <a
                href="#clubEditModal"
                class="action-btn js-open-modal js-edit-club"
                data-modal="#clubEditModal"
                data-id="{{ ch.club_id }}"
                data-name="{{ ch.club_name }}"
                data-coordinator="{{ ch.coordinator or '' }}"
                data-category="{{ ch.club_category or '' }}"
                data-type="{{ ch.coordinator_type or '' }}"
                data-description="{{ ch.description or '' }}"
                data-image-url="{{ url_for('static', filename=ch.club_logo) if ch.club_logo else '' }}"
                data-image-name="{{ ch.club_logo.split('/')[-1] if ch.club_logo else '' }}"
              >
                Edit
              </a>

              {# Optional per-row delete (form submit) ‚Äî keep commented if using API delete from card #}
              {#
              <form method="POST" action="{{ url_for('delete_club_form') }}" class="inline" style="display:inline;">
                <input type="hidden" name="club_id" value="{{ ch.club_id }}">
                <button type="submit" class="delete-btn" onclick="return confirm('Delete {{ ch.club_name }}?');">Delete</button>
              </form>
              #}
            </td>
          </tr>
        {% endfor %}
      {% else %}
        <tr>
          <td colspan="6" style="text-align:center; opacity:.7;">No clubs found.</td>
        </tr>
      {% endif %}
      </tbody>
    </table>
  </div>
</section>

{# Hidden delete form (template-route fallback) #}
<form id="deleteClubForm" method="POST" action="{{ url_for('delete_club_form') }}" style="display:none;">
  <input type="hidden" name="club_id" id="deleteClubId">
</form>

{# Delete confirmation modal (Flipkart style) #}
<div id="deleteConfirmModal" class="delete-modal-overlay" hidden>
  <div class="delete-modal">
    <div class="delete-modal-header">
      <h3>Remove Club</h3>
      <button type="button" class="delete-close" id="closeDeleteModal">√ó</button>
    </div>
    <div class="delete-modal-body">
      <p>Are you sure you want to remove this club?</p>
    </div>
    <div class="delete-modal-footer">
      <button id="confirmDeleteBtn" class="btn btn-danger">REMOVE</button>
      <button id="cancelDeleteBtn" class="btn btn-secondary">CANCEL</button>
    </div>
  </div>
</div>

{# Modals #}
{% include "components/club_modal.html" %}
{% include "components/club_edit_modal.html" %}
{% endblock %}

{% block scripts %}
  <script src="{{ url_for('static', filename='scripts.js') }}"></script>

  <style>
    [hidden], .featured-chapter-card[hidden] { display: none !important; }
    .search-bar { position: relative; }

    /* Search dropdown styling */
    #clubChoices {
      position: absolute;
      top: 110%;
      left: 0; right: 0;
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 8px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.1);
      z-index: 50;
      max-height: 180px;
      overflow-y: auto;
      font-size: 14px;
    }
    #clubChoices option {
      padding: 6px 10px;
      cursor: pointer;
    }
    #clubChoices option:hover,
    #clubChoices option:checked {
      background-color: #1a8782;
      color: #fff;
    }

    /* --- Delete confirmation modal --- */
    .delete-modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 999;
    }
    .delete-modal {
      width: 360px;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 6px 20px rgba(0,0,0,.25);
      padding: 16px 16px 14px;
      animation: popIn .18s ease-out;
    }
    @keyframes popIn {
      from { transform: scale(.96); opacity: 0; }
      to   { transform: scale(1);   opacity: 1; }
    }
    .delete-modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid #eee;
      padding-bottom: 8px;
      margin-bottom: 10px;
    }
    .delete-modal-header h3 {
      margin: 0;
      font-size: 18px;
    }
    .delete-close {
      border: 0;
      background: transparent;
      font-size: 20px;
      line-height: 1;
      cursor: pointer;
      padding: 4px 8px;
    }
    .delete-modal-body { font-size: 14px; color: #444; }
    .delete-modal-footer {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 14px;
    }
    .btn-danger {
      background: #2874f0;
      color: #fff;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
    }
    .btn-danger:hover { background: #1956c1; }
    .btn-secondary {
      background: #e5e7eb;
      color: #111827;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
    }
    .btn-secondary:hover { background: #d1d5db; }
  </style>
{% endblock %}
