<div id="announcementEditModal" class="modal-overlay" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="announcementEditTitle">
    <div class="modal-header">
      <h2 class="modal-title" id="announcementEditTitle">Edit Announcement</h2>
      <a href="#" class="close-btn js-close-modal" aria-label="Close">×</a>
    </div>

    <form action="{{ url_for('update_announcement') }}" method="POST" id="editAnnForm">
      <input type="hidden" id="editAnnId" name="id" />
      <input type="hidden" name="source" value="{{ request.endpoint }}">
      <!-- Backend reads this -->
      <input type="hidden" id="editAnnStatusHidden" name="status" value="draft" />

      <!-- Top row: Club + Title -->
      <div class="form-row">
        <div class="form-col">
          <div class="form-group">
            <label for="editAnnClub">Select Club <span class="req">*</span></label>
            <select id="editAnnClub" name="club_id" required>
              <option value="">-- Select a Club --</option>
              {% for cl in clubs or [] %}
                <option value="{{ cl.club_id }}">{{ cl.club_name }}</option>
              {% endfor %}
            </select>
          </div>
        </div>

        <div class="form-col">
          <div class="form-group">
            <label for="editAnnTitle">Announcement Title <span class="req">*</span></label>
            <input type="text" id="editAnnTitle" name="title" required placeholder="e.g., Hackathon Registration Open">
          </div>
        </div>
      </div>

      <!-- Content -->
      <div class="form-group">
        <label for="editAnnContent">Announcement Content <span class="req">*</span></label>
        <textarea id="editAnnContent" name="content" required placeholder="Write the announcement details here..."></textarea>
      </div>

      <!-- Publish / Expire -->
      <div class="form-row">
        <div class="form-col">
          <div class="form-group">
            <label>Publish Date &amp; Time</label>
            <div class="form-row">
              <div class="form-col">
                <input type="date" id="editPublishDate" name="publish_date" aria-label="Publish Date" placeholder="dd-mm-yyyy">
              </div>
              <div class="form-col">
                <select id="editPublishTime" name="publish_time" aria-label="Publish Time">
                  {% for hour in range(0,24) %}
                    {% for minute in range(0,60,30) %}
                      {% set hour12 = (hour % 12) or 12 %}
                      {% set ampm = 'AM' if hour < 12 else 'PM' %}
                      <option value="{{ "%02d:%02d" % (hour, minute) }}"{% if hour == 12 and minute == 0 %} selected{% endif %}>{{ "%d:%02d %s" % (hour12, minute, ampm) }}</option>
                    {% endfor %}
                  {% endfor %}
                </select>
              </div>
            </div>
            <div class="input-help">When should this announcement become visible?</div>
          </div>
        </div>

        <div class="form-col">
          <div class="form-group">
            <label>Expiration Date &amp; Time</label>
            <div class="form-row">
              <div class="form-col">
                <input type="date" id="editExpireDate" name="expire_date" aria-label="Expiration Date" placeholder="dd-mm-yyyy">
              </div>
              <div class="form-col">
                <select id="editExpireTime" name="expire_time" aria-label="Expire Time">
                  {% for hour in range(0,24) %}
                    {% for minute in range(0,60,30) %}
                      {% set hour12 = (hour % 12) or 12 %}
                      {% set ampm = 'AM' if hour < 12 else 'PM' %}
                      <option value="{{ "%02d:%02d" % (hour, minute) }}"{% if hour == 12 and minute == 0 %} selected{% endif %}>{{ "%d:%02d %s" % (hour12, minute, ampm) }}</option>
                    {% endfor %}
                  {% endfor %}
                </select>
              </div>
            </div>
            <div class="input-help">Optional: auto remove/hide after this time.</div>
          </div>
        </div>
      </div>

      <!-- Priority + Audience + Status (status is display-only) -->
      <div class="form-row">
        <div class="form-col">
          <div class="form-group">
            <label for="editPriority">Priority Level</label>
            <select id="editPriority" name="priority">
              <option value="normal">Normal</option>
              <option value="high">High</option>
              <option value="urgent">Urgent</option>
            </select>
          </div>
        </div>

        <div class="form-col">
          <div class="form-group">
            <label for="editAudience">Target Audience</label>
            <select id="editAudience" name="audience">
              <option value="all_members">All Club Members</option>
              <option value="coordinators">All Coordinators</option>
              <option value="colleges">All Colleges</option>
              <option value="student_coordinators">Only Student Coordinators</option>
              <option value="college_coordinators">Only College Coordinators</option>
              <option value="members">Only Members</option>
            </select>
          </div>
        </div>

        <div class="form-col">
          <div class="form-group">
            <label for="editAnnStatus">Current Status</label>
            <!-- renamed to avoid colliding with submit buttons -->
            <select id="editAnnStatus" name="status_select" disabled>
              <option value="draft">Draft</option>
              <option value="published">Published</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Options -->
      <div class="form-row">
        <div class="form-col">
          <div class="form-group">
            <label>Additional Options</label>
            <div class="options-inline">
              <label>
                <input type="checkbox" id="editSendEmail" name="send_email">
                <span>Send as email notification</span>
              </label>
              <label>
                <input type="checkbox" id="editPinned" name="pinned">
                <span>Pin this announcement on top</span>
              </label>
            </div>
          </div>
        </div>
      </div>

      <!-- Actions -->
      <div class="modal__footer">
        <button type="button" class="btn btn-light js-close-modal">Cancel</button>

        <!-- Keeps current status (no change) -->
        <button type="submit" class="btn btn-primary" id="btnSaveChanges">Save Changes</button>

        <!-- Explicit status changes -->
        <button type="submit" class="btn btn-secondary" data-status="draft">Save as Draft</button>
        <button type="submit" class="btn btn-primary" id="btnPublishNow" data-status="published">Publish Now</button>
      </div>
    </form>
  </div>
</div>

<script>
(function () {
  // When opening the edit modal
  document.addEventListener('click', function (e) {
    const trigger = e.target.closest('.js-edit-announcement');
    if (!trigger) return;

    const status = (trigger.dataset.status || 'draft').toLowerCase();
    const hidden = document.getElementById('editAnnStatusHidden');
    const statusSelect = document.getElementById('editAnnStatus');
    const publishBtn = document.getElementById('btnPublishNow');
    const draftBtn = document.querySelector('#announcementEditModal [data-status="draft"]');
    const saveBtn = document.getElementById('btnSaveChanges');

    if (hidden) hidden.value = status;
    if (statusSelect) statusSelect.value = status;

    // === Visibility rules ===
    if (status === 'draft') {
      // Draft → show Save Changes + Publish Now
      if (publishBtn) publishBtn.style.display = '';
      if (draftBtn) draftBtn.style.display = 'none';
      if (saveBtn) saveBtn.style.display = '';
    } else {
      // Published → show Save Changes + Save as Draft (hide Publish Now)
      if (publishBtn) publishBtn.style.display = 'none';
      if (draftBtn) draftBtn.style.display = '';
      if (saveBtn) saveBtn.style.display = '';
    }
  });

  // Before form submit → update hidden "status" field
  document.addEventListener('click', function (e) {
    const submitBtn = e.target.closest('#announcementEditModal .modal__footer button[type="submit"]');
    if (!submitBtn) return;

    const hidden = document.getElementById('editAnnStatusHidden');
    const statusSelect = document.getElementById('editAnnStatus');

    const forced = (submitBtn.getAttribute('data-status') || '').toLowerCase();
    if (forced && hidden) {
      hidden.value = forced;
    } else if (hidden && statusSelect) {
      hidden.value = statusSelect.value || 'draft';
    }
  });
})();
</script>


